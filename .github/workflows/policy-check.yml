name: Terraform Policy Check

on: 
  pull_request:
    types: [opened, synchronize]

jobs:
  Terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.4.4
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=plan.tfplan -var="name=dynamo"

      - name: Generate JSON plan
        run: terraform show -json plan.tfplan > plan.json

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 0.44.0

      - name: Install JQ
        run: sudo apt-get install jq

      - name: Evaluate OPA Policy
        run: |
          result=$(opa eval -f json -d policy.rego -i plan.json 'data')
          deny_count=$(echo "$result" | jq '.result.deny | length')

          if [ $deny_count -gt 0 ]; then
            echo "Policy violations detected:"
            echo "$result" | jq -r '.result.deny[]'
            exit 1
          fi
        shell: bash
